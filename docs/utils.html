---

title: Title


keywords: fastai
sidebar: home_sidebar



nb_path: "00_utils.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: 00_utils.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span> 
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#     &quot;&quot;&quot;checks paragraph for key sentences. Returns first matching hit&quot;&quot;&quot;</span>
<span class="c1">#     p_sents = paragraph.split(&quot;.&quot;)</span>
<span class="c1">#     combinations = itertools.product(p_sents, cue_phrases)</span>
<span class="c1">#     hit = &quot;&quot;</span>
<span class="c1">#     for c in combinations:</span>
<span class="c1">#         if c[1] in c[0]:</span>
<span class="c1">#        # if c[0].startswith(c[1]): #easier to work with later assuming beginning of sentence</span>
<span class="c1">#             hit = c[0]</span>
<span class="c1">#             break</span>
<span class="c1">#     return hit</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="split_into_sentences" class="doc_header"><code>split_into_sentences</code><a href="https://github.com/markusstrasser/octoflow/tree/master/octoflow/core.py#L21" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>split_into_sentences</code>(<strong><code>text</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span> 
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="get_pubmed_records" class="doc_header"><code>get_pubmed_records</code><a href="https://github.com/markusstrasser/octoflow/tree/master/octoflow/core.py#L52" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>get_pubmed_records</code>(<strong><code>pmids</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="get_attribute_text" class="doc_header"><code>get_attribute_text</code><a href="https://github.com/markusstrasser/octoflow/tree/master/octoflow/core.py#L65" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>get_attribute_text</code>(<strong><code>AbstractText</code></strong>, <strong><code>NlmCategory</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="get_segment" class="doc_header"><code>get_segment</code><a href="https://github.com/markusstrasser/octoflow/tree/master/octoflow/core.py#L79" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>get_segment</code>(<strong><code>record</code></strong>, <strong><code>segment_label</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="sentence_has_phrase" class="doc_header"><code>sentence_has_phrase</code><a href="https://github.com/markusstrasser/octoflow/tree/master/octoflow/core.py#L93" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>sentence_has_phrase</code>(<strong><code>sentence</code></strong>, <strong><code>cue_phrases</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="find_sentence_in_abstract" class="doc_header"><code>find_sentence_in_abstract</code><a href="https://github.com/markusstrasser/octoflow/tree/master/octoflow/core.py#L99" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>find_sentence_in_abstract</code>(<strong><code>paragraph</code></strong>, <strong><code>bias</code></strong>=<em><code>0</code></em>)</p>
</blockquote>
<p>checks paragraph for key sentences. Returns first matching hit</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">requests</span> <span class="k">as</span> <span class="nn">req</span>

<span class="c1"># url = &quot;https://github.com/derekchuank/high-frequency-vocabulary/blob/master/30k.txt&quot;</span>
<span class="c1"># res = req.get(url)</span>
<span class="c1"># vocab30k = res.text.split(&quot;\t\n&quot;)</span>
<span class="c1"># vocab30k[:5]</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="replace_outof_vocab_words" class="doc_header"><code>replace_outof_vocab_words</code><a href="https://github.com/markusstrasser/octoflow/tree/master/octoflow/core.py#L129" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>replace_outof_vocab_words</code>(<strong><code>text</code></strong>, <strong><code>vocab</code></strong>, <strong><code>nlp</code></strong>=<em><code>&lt;spacy.lang.en.English object at 0x7f5a470d3cf8&gt;</code></em>, <strong><code>extra_vocab</code></strong>=<em><code>['-PRON-', '-pron-', '.', ',', ';']</code></em>, <strong><code>special_tokens</code></strong>=<em><code>{'(': '-lrb-', ')': '-rrb-'}</code></em>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span> 
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">patterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">(</span><span class="sa">r</span><span class="s1">&#39;.*ing$&#39;</span><span class="p">,</span> <span class="s1">&#39;VBG&#39;</span><span class="p">),</span>               <span class="c1"># gerunds</span>
    <span class="p">(</span><span class="sa">r</span><span class="s1">&#39;.*ed$&#39;</span><span class="p">,</span> <span class="s1">&#39;VBD&#39;</span><span class="p">),</span>                <span class="c1"># simple past</span>
    <span class="p">(</span><span class="sa">r</span><span class="s1">&#39;.*es$&#39;</span><span class="p">,</span> <span class="s1">&#39;VBZ&#39;</span><span class="p">),</span>                <span class="c1"># 3rd singular present</span>
    <span class="p">(</span><span class="sa">r</span><span class="s1">&#39;.*ould$&#39;</span><span class="p">,</span> <span class="s1">&#39;MD&#39;</span><span class="p">),</span>               <span class="c1"># modals</span>
    <span class="p">(</span><span class="sa">r</span><span class="s1">&#39;.*</span><span class="se">\&#39;</span><span class="s1">s$&#39;</span><span class="p">,</span> <span class="s1">&#39;NN$&#39;</span><span class="p">),</span>               <span class="c1"># possessive nouns</span>
    <span class="p">(</span><span class="sa">r</span><span class="s1">&#39;.*s$&#39;</span><span class="p">,</span> <span class="s1">&#39;NNS&#39;</span><span class="p">),</span>                 <span class="c1"># plural nouns</span>
    <span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^-?[0-9]+(.[0-9]+)?$&#39;</span><span class="p">,</span> <span class="s1">&#39;CD&#39;</span><span class="p">),</span>  <span class="c1"># cardinal numbers</span>
    <span class="p">(</span><span class="sa">r</span><span class="s1">&#39;.*&#39;</span><span class="p">,</span> <span class="s1">&#39;NN&#39;</span><span class="p">)</span>                     <span class="c1"># nouns (default)</span>
<span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Pubmed-Abstract/Fulltext-Fetching-and-Cleaning">Pubmed Abstract/Fulltext Fetching and Cleaning<a class="anchor-link" href="#Pubmed-Abstract/Fulltext-Fetching-and-Cleaning"> </a></h2><p>Pubmed does not give fulltext/abstract text in a good format. It gives a CSV with the metadata of searched results. That means you have to use the Entrez fetch and then merge the abstracts and text information with the metadata to have something workable</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;clinical_study_abst.txt&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;clin_study_meta.csv&quot;</span><span class="p">)</span>
<span class="n">records</span> <span class="o">=</span> <span class="n">get_pubmed_records</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">pmid</span><span class="p">)</span> <span class="k">for</span> <span class="n">pmid</span> <span class="ow">in</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;PMID&quot;</span><span class="p">]])</span>
<span class="nb">len</span><span class="p">([</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">records</span><span class="p">[</span><span class="s2">&quot;PubmedArticle&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">r</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">])</span>

<span class="n">articles</span> <span class="o">=</span> <span class="n">records</span><span class="p">[</span><span class="s2">&quot;PubmedArticle&quot;</span><span class="p">]</span>

<span class="n">g</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;PMID&quot;</span><span class="p">:</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">get</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="s2">&quot;MedlineCitation.PMID&quot;</span><span class="p">))</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">articles</span><span class="p">],</span>
    
    <span class="s2">&quot;BACKGROUND&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">get_segment</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="s2">&quot;BACKGROUND&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">articles</span><span class="p">],</span>
    <span class="s2">&quot;OBJECTIVE&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">get_segment</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="s2">&quot;OBJECTIVE&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">articles</span><span class="p">],</span>
    <span class="s2">&quot;METHODS&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">get_segment</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="s2">&quot;METHODS&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">articles</span><span class="p">],</span>
    <span class="s2">&quot;RESULTS&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">get_segment</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="s2">&quot;RESULTS&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">articles</span><span class="p">],</span>
    <span class="s2">&quot;CONCLUSIONS&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">get_segment</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="s2">&quot;CONCLUSIONS&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">articles</span><span class="p">]</span>
     <span class="p">}</span>

<span class="n">df2</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>
<span class="n">df2</span><span class="p">[</span><span class="s2">&quot;PMID&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df2</span><span class="p">[</span><span class="s2">&quot;PMID&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="n">dfx</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">df2</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;PMID&quot;</span><span class="p">)</span>
<span class="n">dfx</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s2">&quot;enriched_pm_10k.csv&quot;</span><span class="p">)</span>

<span class="n">dfx</span><span class="o">.</span><span class="n">head</span><span class="p">(),</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">df2</span><span class="p">),</span> <span class="n">df</span><span class="p">[:</span><span class="mi">6768</span><span class="p">][</span><span class="s2">&quot;PMID&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">df2</span><span class="p">[:</span><span class="mi">6768</span><span class="p">][</span><span class="s2">&quot;PMID&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Text-Features-with-spacy-extensions">Text Features with spacy extensions<a class="anchor-link" href="#Text-Features-with-spacy-extensions"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">spacy</span>
<span class="kn">from</span> <span class="nn">spacytextblob.spacytextblob</span> <span class="kn">import</span> <span class="n">SpacyTextBlob</span>

<span class="n">nlp</span> <span class="o">=</span> <span class="n">spacy</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;en_core_web_sm&#39;</span><span class="p">)</span>
<span class="n">nlp</span><span class="o">.</span><span class="n">add_pipe</span><span class="p">(</span><span class="s1">&#39;spacytextblob&#39;</span><span class="p">)</span>
<span class="n">text</span> <span class="o">=</span> <span class="s1">&#39;I had a really horrible day. It was the worst day ever! But every now and then I have a really good day that makes me happy.&#39;</span>
<span class="n">doc</span> <span class="o">=</span> <span class="n">nlp</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
<span class="n">doc</span><span class="o">.</span><span class="n">_</span><span class="o">.</span><span class="n">polarity</span>      <span class="c1"># Polarity: -0.125</span>
<span class="n">doc</span><span class="o">.</span><span class="n">_</span><span class="o">.</span><span class="n">subjectivity</span>  <span class="c1"># Sujectivity: 0.9</span>
<span class="n">doc</span><span class="o">.</span><span class="n">_</span><span class="o">.</span><span class="n">assessments</span>   <span class="c1"># Assessments: [([&#39;really&#39;, &#39;horrible&#39;], -1.0, 1.0, None), ([&#39;worst&#39;, &#39;!&#39;], -1.0, 1.0, None), ([&#39;really&#39;, &#39;good&#39;], 0.7, 0.6000000000000001, None), ([&#39;happy&#39;], 0.8, 1.0, None)]</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

</div>
 

